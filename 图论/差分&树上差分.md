# 差分&树上差分

对于差分数组 $b[]$ 来说，$b[i] = a[i] - a[i-1]$​。描述元素间大小的逻辑关系。

一般多设两个数组：$s[i] = s[i-1] + b[i]$​​。其就等于 $a[i]$​​。
$sum[i] = sum[i-1] + s[i]$​​。即 $a[i]$​​ 的前缀和。

故 $s[i]$​​ 是 $b[]$​​ 的前缀和，$sum[i]$​​ 是 $s[]$​​ 的前缀和。

可以发现 $sum[]$​ ​与 $b[]$ ​​是二次关系：$sum[x] = \sum_{i=1}^{x}(x-i+1)*b[i]$​​

## 区间修改

如在 [l,r] 加 v：只需 d[l] += v, d[r+1] -= v;

### 典型应用

黑白棋翻转。

## 区间统计

每次对差分 d[] 数组统计的时候，不管计算 s[] 还是 sum[]，复杂度都是 O(n) 的。

## 结合树状数组

经差分变换，用树状数组维护时就变成区间修改，单点查询。
另外有区间修改，区间查询的树状数组，当模板用，应用领域小。

## 树上差分

### 路径修改（点）

有 q 次询问，每次在路径 $< u , v >$​​ 上的所有点 i 加上 c 值。
最后求每个点的权值。

利用差分的思路，$cnt_u += c,cnt_v += c,cnt_{lca} -= c,cnt_{fa_{lca}} -= c$，再统计子树和即可。

![image_1e81mdf6dusd1rn114ooj3lhpc9.png-13.6kB][1]

[1]: http://static.zybuluo.com/kinesis/dv5un9ag4yl9ogamx6vh7k4b/image_1e81mdf6dusd1rn114ooj3lhpc9.png

### 路径修改（边）

将边归入深一层的点。
$<s,t>$​ 上的边加 c：$cnt_u += c,cnt_v += c,cnt_{lca} -= 2*c$​

## 差分的题目

### P1083 借教室

由于统计答案时是 O(n) 的，无法边修改边查询。观察到满足需求的订单是连续的，往二分方向思考：当 1~mid 个订单可完成，将其在区间上差分修改，统计时看每天的需求是否超过供给量（即二分的答案是否符合要求）。复杂度为 O(nlogn)

### P3943 星空（待补）



### p3258 松鼠的新家

比较裸，但细节需处理。a[2]~a[n]都加多了1次，在最后输出答案时-1。

### p2680 运输计划

L 国有 $n$ 个星球，还有 $n-1$ 条双向航道，每条航道建立在两个星球之间，这 $n-1$ 条航道连通了 $\mathrm{L}$ 国的所有星球。
小 $\mathrm{P}$ 掌管一家物流公司， 该公司有很多个运输计划，每个运输计划形如：有一艘物流飞船需要从 $u_{i}$ 号星球沿最快的宇航路径飞行到 $v_{i}$ 号星球去。显然飞船驶过一条航道是需要时间的，对于航道 $j$ ，任意飞船驶过它所花费的时间为 $t_{j}$ ，并且任意两艘飞船之间不会产生任何干扰。
为了鼓励科技创新， $L$ 国国王同意小 $P$ 的物流公司参与 $L$ 国的航道建设，即允许小 $P$ 把某一条航道改造成虫洞，飞船驶过虫洞不消耗时间。
在虫洞的建设完成前小 $\mathrm{P}$ 的物流公司就预接了 $m$ 个运输计划。在虫洞建设完成后，这 $m$ 个运输计划会同时开始，所有飞船一起出发。当这 $m$ 个运输计划都完成时，小 $\mathrm{P}$ 的物流公司的阶段性工作就完成了。
如果小 $P$ 可以自由选择将哪一条航道改造成中洞，试求出小 $P$​​​ 的物流公司完成阶段性工作所需要的最短时间是多少?

考虑到使总体最大时间最小化（以时间为尺度的题目），套路地往二分方向去想。当二分到 mid，小于等于mid的路不论是否被修改都满足条件，就将大于 mid 的路径添加到树上，计算边的覆盖次数。如果边的覆盖次数 == 添加路径的总次数，则删除这条边对全体答案有减少的影响，记为 ans。若 ans<=mid，说明删除树上某条边能使所有路径 <=mid，否则答案不符合。若没有边的覆盖次数等于添加路径的次数，mid 也不符合。
