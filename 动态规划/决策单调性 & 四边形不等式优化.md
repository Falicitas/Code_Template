# 决策单调性 & 四边形不等式优化

## 区间dp

区间 dp 的特点在于，能将问题转化为 **两两合并** 的形式。一般通过 **枚举合并点** 的方式，来确定原问题的最优解。
$$
f(i, j)=\max \{f(i, k)+f(k+1, j)+cost\}
$$
其中 k 代表合并点。

## 四边形不等式优化

对于下面的式子
$$
f_{l, r}=\min _{k=l}^{r-1}\left\{f_{l, k}+f_{k+1, r}+w(l, r)\right\} \quad(1 \leq l<r \leq n)
$$
若 $w(l,r)$ 满足 **区间单调性** 和 **四边形不等式** ，则 $f(l,r)$ 满足 **四边形不等式** 。

当 2D1D 形式的状态 **满足四边形不等式** ，设 $m_{l,r}$ 为 $f(l,r)$ 取最优值时的合并点 k ，那么有
$$
m_{l, r-1} \leq m_{l, r} \leq m_{l+1, r} \quad(l+1<r)
$$
由式子
$$
\sum_{1 \leq l<r \leq n} m_{l+1, r}-m_{l, r-1}=\sum_{i=1}^{n} m_{i, n}-m_{1, i} \leq n^{2}
$$
可知，对于所有合法状态 $l,r$ ，枚举的 k 之和 $\leq n^2$ （考虑求和的实际意义，一些相同的项+-合并后没了），所以复杂度为 $O(n^2)$ 。

其中，对于二元函数 $w(l,r)$ ：

- **区间包含单调性** ：如果对于任意 $ l \leq l^{\prime} \leq r^{\prime} \leq r$ ，均有 $w\left(l^{\prime}, r^{\prime}\right) \leq w(l, r)$ 成立，则称函数对于区间包含关系具有单调性。
- **四边形不等式** ：如果对于任意 $l_{1} \leq l_{2} \leq r_{1} \leq r_{2}$ ，均有 $w\left(l_{1}, r_{1}\right)+w\left(l_{2}, r_{2}\right) \leq w\left(l_{1}, r_{2}\right)+w\left(l_{2}, r_{1}\right)$ 成立，则称函数 $w$ 满足四边形不等式（简
  记为 *交叉小于包含* ）。 **若等号永远成立** ，则称函数 $w$ 满足 **四边形恒等式** （四边形不等式的一个特例）。
- **四边形不等式等价条件** ：对于任意 $a<b$ ，若 $w_{a,b+1} + w_{a+1,b} \geq w_{a,b} + w_{a+1,b+1}$ ，则 $w_{l,r}$ 满足四边形不等式。（可证，但不证）

**在实践时直接打表判断，或者参照下面的函数类** 。

注意， opt 均为 min 。

### 满足四边形不等式的函数类

- **性质 1** ：若函数 $w_{1}(l, r), w_{2}(l, r)$ 均满足 **四边形不等式（或区间包含单调性）** ，则对于任意 $c_{1}, c_{2} \geq 0$ ，函数 $c_{1} w_{1}+c_{2} w_{2}$ 也满足 **四边形不等式（或区间包含单调性）** 。
- **性质 2** ：若存在函数 $f(x), g(x)$ 使得 $w(l, r)=f(r)-g(l)$ ，则函数 $w$ 满足 **四边形恒等式** 。当函数 $f, g$ 单调增加时, 函数 $w$ 还满足 **区间包含单调性** 。
- **性质 3** ：设 $h(x)$ 是一个 **单调增加的凸函数** ，若函数 $w(l, r)$ 满足四边形不等式 且 对区间包含关系具有单调性，则复合函数 $h(w(l, r))$ 也满足四边形不等式 和 区间包含单调性。
- **性质 4** ：设 $h(x)$ 是一个 **凸函数** ，若函数 $w(l, r)$ 满足四边形恒等式 且 对区间包含关系具有单调性, 则复合函数 $h(w(l, r))$ 也满足 **四边形不等式** （不一定满足区间单调性）。

> 举例：证明 $w(j,i) = -a_j - \sqrt{i-j} + a_i$ 满足四边形不等式。
>
> 首先， $a_i - a_j$ 可写作 $f(i) - g(j)$ 的形式，故其满足 **四边形恒等式** （性质2）。
>
> 对于 $g(j,i) =  i - j$ ，跟上述相似，其满足 **四边形恒等式 & 区间包含单调性** （性质2）。
>
> 令 $t(x) = -\sqrt{x}$ ，其为 **凸函数** 。那么 $t \circ g = -\sqrt{i-j}$ 满足 **四边形不等式** （性质4） 。
>
> 那么 $a_i - a_j - \sqrt{i-j}$ 满足四边形不等式。

### 另一种形式

$$
f_{i, j}=\min _{k \leq j}\left\{f_{i-1, k}\right\}+w(k, j) \quad(1 \leq i \leq n, 1 \leq j \leq m)
$$

目前不清楚其四边形不等式优化后的样子。等做到题目再说。

## 决策单调性

当有状态转移方程：
$$
f_i = \min_{j\in [1,i)}\{f_j + cost_{j,i}\} 
$$
其中， cost(j,i) 满足 **四边形不等式** ，则 $f_i$ 具有 **决策单调性** 。

**决策单调性** ：当状态 i 对于状态 i' ( i < i' ) ，相对于 j < i 的所有 j 都更优时，那么对于 i'' ( i' < i'' ) ，选 i 均比选 j 要更优。

一般来说，会以某段连续的区间 (l,r) 选 j 为当前最优方案来更新答案，即一个三元组 (j,l,r) 。

具体的，

- 初始化决策集（用单调队列）加入 (0,1,n) ，代表对于 [1,n] 区间的所有状态，选状态 0 是最优的。

- 顺序遍历每个状态，当前状态 i 从最优状态 j 转移而来（即队头元素的 j ）。
- 若队头的区间 [l,r] ，r == i 时，将队头弹出，代表 **[l,r] 的所有状态更新完毕** 。将每次新队头的 l 更新成 i + 1 （由于 i 由上步更新完毕）。
- 插入状态 i 。
- 对于插入来说，若当前状态 i 对于队尾的 (j,l,r) ，对于 l 来说，选 i 比选 j 更优，那意味着整段 [l,r] 选 i 比选 j 更优，此时把队尾剔除。
- 若队列还有元素 (j,l,r) ，且对于 r 来说，选 i 比选 j 更优，那意味着 [l,r] 之间存在一个位置 p ，在 [l,p] 时选 j 更优，在 [p + 1,r] 时选 i 更优。二分出 p 的位置，将队尾的 (j,l,r) 修改为 (j,l,p) 。
- 那剩下的，直到 n 的状态，选 i 比选之前的 j 都更优。此时把状态 (i,pos,n) ， pos 是选 i 更优的第一个位置（在上述过程中顺带求出 pos ）。

对于上述过程，对于每个状态 i ，仅会被插入到队列中 1 次，同时也只会被删除 1 一次，故复杂度瓶颈在 $O(n)$ 次二分。

复杂度 $O(n\log n)$ 。

## 一些习题

### P3515 [POI2011]Lightning Conductor

